#! /bin/bash

WEBHOOK_URL="##webook_url##"
QUARANTINE="/usr/local/etc/clamav/quarantine"
ONACCESSLOG="/var/log/clamav/onaccess.log"
USER_LIST=($(ls /Users/ | grep -v .localized));
USER_DOWNLOADS_DIRS=(`for user in ${USER_LIST[@]} ; do echo "/Users/"$user"/Downloads"; done`)
USER_DESKTOP_DIRS=(`for user in ${USER_LIST[@]} ; do echo "/Users/"$user"/Desktop"; done`)

TARGET_DIRS=(${USER_DOWNLOADS_DIRS[*]} ${USER_DESKTOP_DIRS[*]})
IFS=$'\n'
CLAMDSCAN="/usr/local/bin/clamdscan"
if [ -e "/opt/homebrew/bin/clamdscan" ]; then
    CLAMDSCAN="/opt/homebrew/bin/clamdscan"
fi

for dirname in ${TARGET_DIRS[*]}; do
    echo $dirname
    RESULT=$($CLAMDSCAN --multiscan --fdpass --recursive --max-recursion=5 --move=$QUARANTINE --log=$ONACCESSLOG "$dirname/" 2>&1);
    FOUNDS=$(echo "$RESULT" | grep -e "FOUND$")
    MOVEDS=$(echo "$RESULT" | grep -e ": moved to")
    for FOUND in ${FOUNDS[*]}; do
        DETECTED_FILE=$(echo "$FOUND" | sed -Ee  "s/: [^ ]+ [^ ]+$//");
        MALNAME=$(echo "$FOUND" | awk '{print $(NF-1)}');
        echo $DETECTED_FILE
        echo $MALNAME
        HASH=""
        MOVED_FILE_TO=""
        for MOVED in ${MOVEDS[*]}; do
            MOVED_FILE_FROM=$(echo "$MOVED" | awk -F ": moved to " '{print $1}')
            if [ "$DETECTED_FILE" = "$MOVED_FILE_FROM" ]; then
                MOVED_FILE_TO=$(echo "$MOVED" | awk -F ": moved to " '{print $2}' | sed -e "s/^'\(.*\)'$/\1/")
                HASH=$(/usr/bin/shasum -a 256 "$MOVED_FILE_TO" | awk '{print $1}');
                HASH=${HASH//\\/}
                break
            fi
        done
        echo $HASH
        OWNER=$(ls -ld "$MOVED_FILE_TO" | awk '{ print $3 '});
        ESCAPED_FILENAME=${DETECTED_FILE//\\/\\\\}
        ESCAPED_FILENAME=${ESCAPED_FILENAME//\"/\\\"}
        curl -sS -X POST --data-urlencode "payload={
            \"username\": \"malware alert\", \
            \"icon_emoji\": \":imp:\", \
            \"attachments\":[ \
                { \
                    \"pretext\":\"${MALNAME} was detected.\", \
                    \"color\":\"#D00000\", \
                    \"fields\":[ \
                        { \
                        \"title\":\"Name\", \
                        \"value\":\"${MALNAME}\", \
                        \"short\":false \
                        }, \
                        { \
                        \"title\":\"User\", \
                        \"value\":\"${OWNER}\", \
                        \"short\":true \
                        }, \
                        { \
                        \"title\":\"Host\", \
                        \"value\":\"`hostname`\", \
                        \"short\":true \
                        }, \
                        { \
                        \"title\":\"IP\", \
                        \"value\":\"`ipconfig getifaddr en0`\", \
                        \"short\":true \
                        }, \
                        { \
                        \"title\":\"Date\", \
                        \"value\":\"`date`\", \
                        \"short\":true \
                        }, \
                        { \
                        \"title\":\"path\", \
                        \"value\":\"${ESCAPED_FILENAME}\", \
                        \"short\":false \
                        }, \
                        { \
                        \"title\":\"hash\", \
                        \"value\":\"<https://www.virustotal.com/gui/file/${HASH}/detection|${HASH}>\", \
                        \"short\":false \
                        } \
                    ] \
                } \
            ] \
            }" ${WEBHOOK_URL} > /dev/null
    done
done