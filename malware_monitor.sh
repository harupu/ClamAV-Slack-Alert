#! /bin/bash

WEBHOOK_URL="##webook_url##"
QUARANTINE="/usr/local/etc/clamav/quarantine"
ONACCESSLOG="/var/log/clamav/onaccess.log"
USER_LIST=($(ls /Users/ | grep -v .localized));
USER_DOWNLOADS_DIRS=(`for user in ${USER_LIST[@]} ; do echo "/Users/"$user"/Downloads"; done`)
USER_DESKTOP_DIRS=(`for user in ${USER_LIST[@]} ; do echo "/Users/"$user"/Desktop"; done`)
/usr/local/bin/fswatch -0 -l 1 -e "/\.DS_Store$" -e "\.crdownload$" -e "/\.com\.google\.Chrome\..*$" -r "${USER_DOWNLOADS_DIRS[@]}" "${USER_DESKTOP_DIRS[@]}" \
    | while read -d "" -r filename 
        do 
            if [ -e "$filename" ]; then
                OWNER=$(ls -ld "$filename" | awk '{ print $3 '});
                RESULT=$(/usr/local/bin/clamdscan --multiscan --fdpass --move=$QUARANTINE --log=$ONACCESSLOG "$filename" 2>&1);
                FOUND=$(echo "$RESULT" | grep -e "FOUND$")
                MOVED=$(echo "$RESULT" | grep -e ": moved to" | awk -F ": moved to " '{print $2}')
                if [ -n "$FOUND" ]; then
                    MALNAME=$(echo "$FOUND" | awk '{print $(NF-1)}');
                    HASH=$(/usr/bin/shasum -a 256 "$MOVED" | awk '{print $1}');
                    HASH=${HASH//\\/}
                    ESCAPED_FILENAME=${filename//\\/\\\\}
                    ESCAPED_FILENAME=${ESCAPED_FILENAME//\"/\\\"}
                    curl -sS -X POST --data-urlencode "payload={
                        \"username\": \"malware alert\", \
                        \"icon_emoji\": \":imp:\", \
                        \"attachments\":[ \
                            { \
                                \"pretext\":\"${MALNAME} was detected.\", \
                                \"color\":\"#D00000\", \
                                \"fields\":[ \
                                    { \
                                    \"title\":\"Name\", \
                                    \"value\":\"${MALNAME}\", \
                                    \"short\":false \
                                    }, \
                                    { \
                                    \"title\":\"User\", \
                                    \"value\":\"${OWNER}\", \
                                    \"short\":true \
                                    }, \
                                    { \
                                    \"title\":\"Host\", \
                                    \"value\":\"`hostname`\", \
                                    \"short\":true \
                                    }, \
                                    { \
                                    \"title\":\"IP\", \
                                    \"value\":\"`ipconfig getifaddr en0`\", \
                                    \"short\":true \
                                    }, \
                                    { \
                                    \"title\":\"Date\", \
                                    \"value\":\"`date`\", \
                                    \"short\":true \
                                    }, \
                                    { \
                                    \"title\":\"path\", \
                                    \"value\":\"${ESCAPED_FILENAME}\", \
                                    \"short\":false \
                                    }, \
                                    { \
                                    \"title\":\"hash\", \
                                    \"value\":\"<https://www.virustotal.com/gui/file/${HASH}/detection|${HASH}>\", \
                                    \"short\":false \
                                    } \
                                ] \
                            } \
                        ] \
                        }" ${WEBHOOK_URL} > /dev/null
                fi
            fi
        done
